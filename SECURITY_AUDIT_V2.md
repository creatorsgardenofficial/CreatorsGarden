# セキュリティ監査レポート（第2回）

## 監査日: 2025年1月（修正後）

## 実行概要

前回の監査で発見された問題点を修正した後、再度包括的なセキュリティ監査を実施しました。修正内容の確認と、残存する問題点を記載します。

---

## ✅ 修正完了項目

### 1. URL検証の実装 ✅

**修正内容**:
- `lib/contentFilter.ts` に `validateUrl()` 関数を追加
- http/https プロトコルのみ許可
- SSRF対策としてローカルホスト・プライベートIPをブロック
- 以下のエンドポイントで実装：
  - `app/api/auth/register/route.ts` - 登録時の作品URL
  - `app/api/auth/profile/route.ts` - プロフィール更新時の作品URL
  - `app/api/posts/route.ts` - 投稿作成時のURL
  - `app/api/posts/[id]/route.ts` - 投稿更新時のURL

**検証結果**: ✅ 正常に実装されており、無効なURLは適切に拒否される

---

### 2. メールアドレス検証の実装 ✅

**修正内容**:
- `lib/contentFilter.ts` に `validateEmail()` 関数を追加
- 正規表現による形式検証
- 以下のエンドポイントで実装：
  - `app/api/auth/register/route.ts` - ユーザー登録時
  - `app/api/auth/login/route.ts` - ログイン時
  - `app/api/feedback/route.ts` - フィードバック送信時

**検証結果**: ✅ 正常に実装されており、無効なメールアドレスは適切に拒否される

---

## 🔴 残存する重大な問題

### 1. パスワードの平文保存

**現状**: パスワードがハッシュ化されずに平文で保存されている

**影響範囲**:
- `lib/storage.ts` - ユーザー作成・更新時
- `app/api/auth/register/route.ts` - 登録時
- `app/api/auth/login/route.ts` - ログイン時の比較（`user.password !== password`）
- `app/api/admin/users/route.ts` - パスワード変更時

**リスク**: 
- 🔴 **最高**: データベース（JSONファイル）が漏洩した場合、全ユーザーのパスワードが即座に露出
- 管理者が全ユーザーのパスワードを閲覧可能
- パスワードリセット機能がない場合、セキュリティリスクが高い

**推奨対策**:
```typescript
// bcrypt を使用したパスワードハッシュ化
import bcrypt from 'bcryptjs';

// 登録時
const hashedPassword = await bcrypt.hash(password, 10);

// ログイン時
const isValid = await bcrypt.compare(password, user.password);
```

**既存ユーザーの移行**:
- 既存の平文パスワードをハッシュ化する移行スクリプトが必要
- 次回ログイン時に自動的にハッシュ化する仕組みを実装

**優先度**: 🔴 最高（即座に対応が必要）

---

## 🟡 中程度の問題点

### 2. レート制限の欠如

**問題**: APIエンドポイントにレート制限がない

**リスク**:
- ブルートフォース攻撃（ログイン試行の無制限）
- DDoS攻撃
- スパム投稿・コメント

**推奨対策**:
- Next.jsのミドルウェアでレート制限を実装
- ログイン試行回数の制限（例: 5回/15分）
- 投稿作成の頻度制限（例: 10回/時間）

**優先度**: 🟡 中

---

### 3. CSRF対策の不足

**問題**: CSRF（クロスサイトリクエストフォージェリ）対策が不十分

**現状**: 
- Cookieに`sameSite: 'lax'`が設定されている（部分的に有効）
- CSRFトークンの実装がない

**推奨対策**:
- CSRFトークンの実装
- または、SameSite Cookieを`strict`に変更（ただしUXに影響）

**優先度**: 🟡 中

---

### 4. セキュリティログの欠如

**問題**: セキュリティイベントのログ記録がない

**リスク**:
- 不正アクセス試行の検知が困難
- セキュリティインシデントの調査が困難

**推奨対策**:
- ログイン試行の記録（成功/失敗）
- 管理者操作の記録
- 異常なアクセスパターンの検知

**優先度**: 🟡 中

---

## ✅ 良好な点（確認済み）

### 1. XSS対策 ✅
- Reactの自動エスケープ機能により、基本的なXSS対策は実装済み
- `dangerouslySetInnerHTML`の使用なし
- コンテンツフィルタリング機能あり

### 2. 認証・認可チェック ✅
- 主要なAPIエンドポイントで認証チェックが実装されている
- 投稿・コメント・メッセージの編集・削除は投稿者のみ
- 管理者機能は管理者のみアクセス可能
- 利用停止ユーザーのチェックが実装されている（19箇所で確認）

### 3. 入力検証 ✅
- コンテンツフィルタリング（不適切な言葉の検出）
- パスワード強度バリデーション
- 必須項目のチェック
- **URL検証**（新規実装）✅
- **メールアドレス検証**（新規実装）✅

### 4. エラーハンドリング ✅
- 適切なtry-catchブロック
- 適切なHTTPステータスコード
- エラーメッセージの表示

### 5. セッション管理 ✅
- HttpOnly Cookieの使用
- Secure Cookie（本番環境）
- SameSite Cookieの設定

### 6. データ保護 ✅
- パスワードはAPIレスポンスから除外されている
- ユーザー一覧取得時もパスワードは除外

---

## 🔍 機能動作確認（再確認）

### 認証機能
- ✅ ユーザー登録: 正常動作（メールアドレス検証あり）
- ✅ ログイン: 正常動作（メールアドレス検証あり）
- ✅ ログアウト: 正常動作
- ✅ セッション管理: 正常動作
- ⚠️ パスワード: 平文保存（要修正）

### 投稿機能
- ✅ 投稿作成: 正常動作（URL検証あり）
- ✅ 投稿一覧: 正常動作（フィルター、ページネーション）
- ✅ 投稿詳細: 正常動作
- ✅ 投稿編集: 正常動作（権限チェックあり、URL検証あり）
- ✅ 投稿削除: 正常動作（権限チェックあり）

### コメント機能
- ✅ コメント投稿: 正常動作
- ✅ コメント表示: 正常動作
- ✅ コメント編集: 正常動作（権限チェックあり）
- ✅ コメント削除: 正常動作（権限チェックあり）

### いいね機能
- ✅ いいね追加/削除: 正常動作
- ✅ 未ログインユーザー対応: 正常動作
- ✅ いいね数表示: 正常動作

### メッセージング機能
- ✅ DM送信: 正常動作
- ✅ DM受信: 正常動作
- ✅ グループチャット: 正常動作
- ✅ メッセージ編集/削除: 正常動作（権限チェックあり）
- ✅ 未読数管理: 正常動作

### フィードバック機能
- ✅ フィードバック送信: 正常動作（メールアドレス検証あり）
- ✅ 管理者返信: 正常動作
- ✅ 通知機能: 正常動作

### 管理者機能
- ✅ フィードバック管理: 正常動作
- ✅ ユーザー管理: 正常動作
- ✅ パスワード変更: 正常動作（ただし平文保存）
- ✅ アカウント停止: 正常動作

---

## 📊 セキュリティスコア比較

### 修正前: 6.5/10
- URL検証: ❌ なし
- メールアドレス検証: ❌ 不足
- パスワードハッシュ化: ❌ なし

### 修正後: 7.5/10
- URL検証: ✅ 実装済み
- メールアドレス検証: ✅ 実装済み
- パスワードハッシュ化: ❌ 未実装（重大な問題）

**改善点**: +1.0ポイント（URL検証とメールアドレス検証の実装により改善）

---

## 📋 推奨改善事項（優先順位順）

### 即座に対応が必要

1. **パスワードのハッシュ化** 🔴
   - bcryptを使用したパスワードハッシュ化の実装
   - 既存ユーザーのパスワード移行スクリプトの作成
   - 次回ログイン時の自動ハッシュ化

### 早急に対応が必要

2. **レート制限の実装** 🟡
   - ログイン試行回数の制限
   - API呼び出しの頻度制限

3. **CSRF対策の強化** 🟡
   - CSRFトークンの実装

### 中期的に対応

4. **セキュリティログ機能の追加** 🟡
   - セキュリティイベントのログ記録
   - 不正アクセス試行の記録

5. **データベースへの移行** 🟡
   - JSONファイルからデータベース（PostgreSQL/MySQL）への移行
   - トランザクション処理の実装

---

## 🛡️ セキュリティベストプラクティス

### 実装済み ✅
- ✅ HttpOnly Cookie
- ✅ Secure Cookie（本番環境）
- ✅ SameSite Cookie
- ✅ コンテンツフィルタリング
- ✅ 認証・認可チェック
- ✅ 利用停止ユーザーのチェック
- ✅ エラーハンドリング
- ✅ **URL検証**（新規実装）
- ✅ **メールアドレス検証**（新規実装）

### 未実装（推奨）⚠️
- ⚠️ パスワードハッシュ化
- ⚠️ レート制限
- ⚠️ CSRFトークン
- ⚠️ セキュリティログ

---

## 📈 改善状況

### 修正前の主な問題点
1. ❌ URL検証の不足
2. ❌ メールアドレス検証の不足
3. ❌ パスワードの平文保存

### 修正後の状況
1. ✅ URL検証の実装完了
2. ✅ メールアドレス検証の実装完了
3. ❌ パスワードの平文保存（未修正、重大な問題として残存）

---

## 🎯 アクションプラン

### フェーズ1（緊急）: 1-2週間
1. **パスワードハッシュ化の実装** 🔴
   - bcryptライブラリの導入
   - パスワードハッシュ化の実装
   - 既存ユーザーの移行スクリプト作成

### フェーズ2（重要）: 1ヶ月
2. レート制限の実装
3. CSRF対策の強化

### フェーズ3（改善）: 2-3ヶ月
4. セキュリティログ機能の追加
5. データベースへの移行

---

## 📝 注意事項

- 本監査は開発環境での確認に基づいています
- 本番環境では追加のセキュリティ対策を推奨します
- 定期的なセキュリティ監査の実施を推奨します
- **パスワードの平文保存は重大な脆弱性のため、最優先で対応が必要です**

---

## 🔗 参考資料

- [OWASP Top 10](https://owasp.org/www-project-top-ten/)
- [Next.js Security Best Practices](https://nextjs.org/docs/app/building-your-application/configuring/security-headers)
- [OWASP Password Storage Cheat Sheet](https://cheatsheetseries.owasp.org/cheatsheets/Password_Storage_Cheat_Sheet.html)

---

## まとめ

前回の監査で発見された問題点のうち、**URL検証**と**メールアドレス検証**は正常に実装されました。しかし、**パスワードの平文保存**という重大な脆弱性が残存しています。この問題は最優先で対応する必要があります。

その他のセキュリティ対策（認証・認可、入力検証、エラーハンドリングなど）は適切に実装されており、システムの基本的なセキュリティレベルは良好です。

