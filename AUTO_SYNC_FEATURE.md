# 自動同期機能の実装

期限が過ぎたら自動でプラン情報が反映される機能を実装しました。

## 🎯 実装内容

### 1. `/api/auth/me` エンドポイントでの自動同期

ユーザー情報を取得する際に、以下の条件で自動的に同期を試みます：

- **期限切れチェック**: `cancelAtPeriodEnd` が `true` で、`currentPeriodEnd` が過去の日付の場合
- **無効なステータスチェック**: `status` が `canceled`, `unpaid`, `past_due`, `incomplete_expired` の場合

同期処理は**非同期でバックグラウンド実行**されるため、レスポンス時間に影響しません。

### 2. プランページでの定期チェック

プランページ（`/pricing`）では、**5分ごとに自動的にユーザー情報をチェック**します。

これにより、ページを開きっぱなしにしている場合でも、期限切れを検知できます。

### 3. Navbarコンポーネントでの自動チェック

Navbarコンポーネント（すべてのページで表示）でも、ユーザー情報取得時に自動同期が試みられます。

## 📋 動作フロー

### 通常のページアクセス時

```
ユーザーがページにアクセス
  ↓
/api/auth/me が呼ばれる
  ↓
期限切れをチェック
  ↓
期限が過ぎている場合、自動的に同期を開始（バックグラウンド）
  ↓
ユーザー情報を返す（同期完了を待たない）
  ↓
次のリクエストで最新の情報が返される
```

### プランページでの定期チェック

```
プランページを開く
  ↓
初回: ユーザー情報を取得（自動同期も試みる）
  ↓
5分ごとに: ユーザー情報を再取得（自動同期も試みる）
  ↓
期限が過ぎている場合、自動的にFreeプランに切り替わる
```

## ✅ 動作条件

自動同期が実行される条件：

1. **期限切れ**: `cancelAtPeriodEnd: true` かつ `currentPeriodEnd` が過去の日付
2. **無効なステータス**: `status` が `canceled`, `unpaid`, `past_due`, `incomplete_expired`
3. **サブスクリプションIDが存在**: `stripeSubscriptionId` が設定されている
4. **Freeプランでない**: 既に `planType: "free"` の場合は同期不要

## 🔍 確認方法

### サーバーログの確認

自動同期が実行されると、以下のログが表示されます：

```
AutoSync: 期限切れを検知、バックグラウンドで同期を開始
AutoSync: 同期完了
```

### データベースの確認

`data/users.json` で以下を確認：

```json
{
  "subscription": {
    "planType": "free",
    "status": "canceled",
    "currentPeriodEnd": "2024-01-01T00:00:00.000Z",
    "cancelAtPeriodEnd": true
  }
}
```

## ⚠️ 注意事項

1. **非同期処理**: 同期処理はバックグラウンドで実行されるため、最初のリクエストでは古い情報が返される可能性があります
2. **次のリクエストで反映**: 同期が完了すると、次のリクエストで最新の情報が返されます
3. **レート制限**: Stripe APIにはレート制限があるため、過度な同期は避けられます（条件チェックで制限）
4. **エラーハンドリング**: 同期処理でエラーが発生しても、通常のユーザー情報取得は続行されます

## 🎯 メリット

1. **自動反映**: ユーザーがボタンを押さなくても、期限切れが自動的に反映されます
2. **バックグラウンド処理**: レスポンス時間に影響しません
3. **定期チェック**: プランページでは定期的にチェックするため、長時間開きっぱなしでも検知できます

## 📚 関連ファイル

- `app/api/auth/me/route.ts` - 自動同期の実装
- `app/pricing/page.tsx` - 定期チェックの実装
- `components/Navbar.tsx` - ユーザー情報取得時の自動同期
- `app/api/stripe/sync-subscription/route.ts` - 同期処理の実装

